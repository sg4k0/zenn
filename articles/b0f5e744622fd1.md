---
title: "GitHubActionsã‚’ä¸¦åˆ—ã§å®Ÿè¡Œã™ã‚‹"
emoji: "ðŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:  ["github", "docker"]
published: true
---

ä»¥å‰ã€GitHubActionsã‚’åˆ©ç”¨ã—ã¦ã€Firebaseã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹è¨­å®šã‚’å®Ÿæ–½ã—ã¾ã—ãŸã€‚
ãã®å¾ŒCIã‚’å®Ÿè£…ã—ãŸã®ã§ã™ãŒã€ç›´åˆ—ã§å®Ÿè¡Œã—ã¦ã„ã¾ã—ãŸã€‚
å€‹äººé–‹ç™ºãƒ¬ãƒ™ãƒ«ã§ã‚ã‚Œã°ã€ç›´åˆ—ã§ã‚‚å•é¡Œãªã„ã¨æ€ã„ã¤ã¤ã€ã‚„ã¯ã‚Šä¸¦åˆ—å®Ÿè¡Œã§ãã‚‹éƒ¨åˆ†ã¯ä¸¦åˆ—ã«ã—ãŸã„ã¨æ€ã†ã®ãŒäººã®æ€§â€¦ã€‚
ä¸¦åˆ—å®Ÿè¡Œã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¾ã—ãŸã€‚

https://zenn.dev/sg4k0/articles/e71d87efa33050

## ã¯ã˜ã‚ã«

å¤§å‰æã¨ã—ã¦ã€ç¾æ™‚ç‚¹ã§ã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã¿å®Ÿè£…ã—ã¦ãŠã‚Šã€ã‹ã¤ç’°å¢ƒã¯Dockerã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
ç¾åœ¨ã€CIã§å®Ÿæ–½ã—ã¦ã„ã‚‹ã®ã¯`ESLint`ã¨`Vitest`ã®å®Ÿè¡Œã§ã™ã€‚
ã•ã‚‰ã«ã€Dockerã¯ã‚ãã¾ã§ã‚‚é–‹ç™ºç’°å¢ƒã¨Buildã«ã®ã¿åˆ©ç”¨ã—ã¦ãŠã‚Šã€Dockerã‚’ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã¸Pushã™ã‚‹ã‚ˆã†ãªã“ã¨ã¯ã—ã¦ã„ã¾ã›ã‚“ã€‚
ãã®ãŸã‚ã€GitHubActionsã®Cacheã‚’åˆ©ç”¨ã—ãŸä¸¦åˆ—åŒ–ã‚’å®Ÿæ–½ã—ã¦ã„ã¾ã™ã€‚

ä»Šå›žèª¬æ˜Žã®ãŸã‚ã«åˆ©ç”¨ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚
`firebase_emulator`ã¯Firebaseã®ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã‚’èµ·å‹•ã•ã›ã‚‹ãŸã‚ã®ç’°å¢ƒã€`frontend`ã¯Reactã‚’åˆ©ç”¨ã—ãŸãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚·ã‚¹ãƒ†ãƒ ã«ãªã‚Šã¾ã™ã€‚
```
app
â”œâ”€ .github
â”‚ â””â”€â”€ workflows
|    â””â”€â”€ test.yml
â”œâ”€ firebase_emulator
â”‚ â””â”€â”€ Dockerfile
â”œâ”€ frontend
â”‚ â”œâ”€â”€ Dockerfile
â”‚ â””â”€â”€ package.jsonã‚„yarn.lockãªã©
â””â”€ docker-compose.yml
```

## 1. ç’°å¢ƒæº–å‚™ç”¨ã®Job

`ESLint`ãŠã‚ˆã³`Vitest`ã‚’ä¸¦åˆ—ã§å®Ÿè¡Œã•ã›ã‚‹ãŸã‚ã«ã€å‰æ®µã§å„Jobã§å¿…è¦ã¨ãªã‚‹DockerImageã®Cacheã¨node_modulesã®Cacheã‚’ä½œæˆã—ã¾ã™ã€‚
ä»¥ä¸‹ãŒç’°å¢ƒæº–å‚™ç”¨ã®Jobã«ãªã‚Šã¾ã™ã€‚

```yaml
setup:
  name: Setup
  runs-on: ubuntu-latest
  outputs:
    commit-hash: ${{ steps.yarn-lock-file-commit-hash.outputs.commit-hash }}
  timeout-minutes: 10
  steps:
    - name: checkout pushed commit
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Yarn Lock File Commit Hash
      id: yarn-lock-file-commit-hash
      run: |
        COMMIT_HASH="$(git log -n 1 --pretty=%H --date-order -- frontend/yarn.lock)"
        echo "COMMIT_HASH=${COMMIT_HASH}" >> $GITHUB_ENV
        echo "commit-hash=$COMMIT_HASH" >> GITHUB_OUTPUT
    - uses: docker/setup-buildx-action@v2
    - uses: docker/build-push-action@v4
      with:
        context: ./frontend
        build-args: |
          NODE_VER=${{ env.NODE_VER }}
          FIREBASE_VER=${{ env.FIREBASE_VER }}
        tags: test-react:latest
        load: true
        cache-from: type=gha,scope=react
        cache-to: type=gha,mode=max,scope=react
    - uses: docker/build-push-action@v4
      with:
        context: ./firebase_emulator
        build-args: |
          NODE_VER=${{ env.NODE_VER }}
          OPEN_JDK_VER=${{ env.OPEN_JDK_VER }}
          FIREBASE_VER=${{ env.FIREBASE_VER }}
        tags: test-emulator:latest
        load: true
        cache-from: type=gha,scope=emulator
        cache-to: type=gha,mode=max,scope=emulator
    - name: Cache node_modules
      uses: actions/cache@v3
      id: test_node_modules
      with:
        path: /tmp/node_modules/
        key: test_node_modules-${{env.COMMIT_HASH}}
    - name: Cache Directory
      if: steps.test_node_modules.outputs.cache-hit != 'true'
      run: |
        sudo mkdir -p /tmp/node_modules
    - name: docker volume create
      run: |
        docker volume create test_node_modules
        sudo cp -r /tmp/node_modules/. /var/lib/docker/volumes/test_node_modules/_data
    - name: run test on docker-compose
      run: |
        docker compose run --rm react yarn install
        sudo cp -rf /var/lib/docker/volumes/test_node_modules/_data/. /tmp/node_modules
      working-directory: ./
```

ãã‚Œãžã‚Œè¦æ‰€è¦æ‰€ã‚’æŠœãå‡ºã—ã¦èª¬æ˜Žã—ã¦ã„ãã¾ã™ã€‚

### node_modulesã®Cache

#### Outputsã®è¨­å®š

```yaml
  outputs:
    commit-hash: ${{ steps.yarn-lock-file-commit-hash.outputs.commit-hash }}
[çœç•¥]
    - name: checkout pushed commit
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Yarn Lock File Commit Hash
      id: yarn-lock-file-commit-hash
      run: |
        COMMIT_HASH="$(git log -n 1 --pretty=%H --date-order -- frontend/yarn.lock)"
        echo "COMMIT_HASH=${COMMIT_HASH}" >> $GITHUB_ENV
        echo "commit-hash=$COMMIT_HASH" >> GITHUB_OUTPUT
```

ä¸¦åˆ—åŒ–ã—ãŸJobã«å¼•ãæ¸¡ã™å¼•æ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚
ä»Šå›žã€yarn.lockã‚’æœ€å¾Œã«æ›´æ–°ã—ãŸCommitã®Hashã‚’æ¸¡ã—ã¦ã„ã¾ã™ã€‚(å¾Œè¿°)
Commitã®Hashã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã¯ã€`actions/checkout`ã«`fetch-depth: 0`ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯æœ€å¾Œã®CommitLogã®ã¿å–å¾—ã•ã‚Œã‚‹ãŸã‚ã€`fetch-depth: 0`ã‚’æŒ‡å®šã—ã¦ã™ã¹ã¦ã®CommitLogã‚’å–å¾—ã—ã¾ã™ã€‚
`git log`ã‚³ãƒžãƒ³ãƒ‰ã‚’åˆ©ç”¨ã—ã¦ã€yarn.lockã‚’æœ€å¾Œã«æ›´æ–°ã—ãŸCommitã®Hashã‚’ï¼‘è¡Œå–å¾—ã—ã¦ã„ã¾ã™ã€‚
ãã®çµæžœã‚’ç’°å¢ƒå¤‰æ•°`COMMIT_HASH`ã¨Outputsã®`commit-hash`ã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚
Outputsã¯`steps.[id].outputs.[key]`ã§è©²å½“Stepã®Outputã‚’æŒ‡å®šã—ã¾ã™ã€‚

#### Cacheã®èª­ã¿è¾¼ã¿ãŠã‚ˆã³Cacheç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ

```yaml
    - name: Cache node_modules
      uses: actions/cache@v3
      id: test_node_modules
      with:
        path: /tmp/node_modules/
        key: test_node_modules-${{env.COMMIT_HASH}}
    - name: Cache Directory
      if: steps.test_node_modules.outputs.cache-hit != 'true'
      run: |
        sudo mkdir -p /tmp/node_modules
```

GitHubActionsã«ç”¨æ„ã•ã‚Œã¦ã„ã‚‹[actions/cache](https://docs.github.com/ja/actions/using-workflows/caching-dependencies-to-speed-up-workflows)ã‚’åˆ©ç”¨ã—ã¦ã€node_modulesã®Cacheã‚’ä½œæˆã—ã¾ã™ã€‚
`actions/cache`ã¯è©²å½“ã™ã‚‹`key`ãŒå­˜åœ¨ã—ãŸå ´åˆã«æŒ‡å®šã•ã‚ŒãŸ`path`ã«Cacheã‚’å±•é–‹ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
åŒã˜keyã§Cacheã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨ãŒã§ããªã„ãŸã‚ã€yarn.lockãŒæ›´æ–°ã•ã‚ŒãŸã‚‰keyãŒæ›´æ–°ã•ã‚Œã‚‹ã‚ˆã†ã«Commitã®Hashã‚’åˆ©ç”¨ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚
ãã†ã™ã‚‹ã“ã¨ã§ã€yarn.lockãŒæ›´æ–°ã•ã‚Œã¦ã„ãªã„ã¨ãã¯å‰å›žã®Cacheã‚’åˆ©ç”¨ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã€yarn.lockãŒæ›´æ–°ã•ã‚ŒãŸã‚‰æ–°ãŸã«CacheãŒä½œæˆã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
`if: steps.test_node_modules.outputs.cache-hit != 'true'`ã¯CacheãŒHitã—ãªã‹ã£ãŸã¨ãã®å‡¦ç†ã§ã€CacheãŒèª­ã¿è¾¼ã‚ãªã‹ã£ãŸã¨ãã¯`/tmp/node_modules`ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
CacheãŒHitã—ãªã„ã¨ãã¯å‰å›žã®Commitã®Hashã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«ã—ãŸã‚‰æ›´ã«yarn installã®æ™‚é–“ã‚’çŸ­ç¸®ã§ãã‚‹ã‚ˆã†ãªæ°—ãŒã—ã¾ã™ãŒã€ä»Šå›žã¯ãã“ã¾ã§å®Ÿæ–½ã—ã¦ã„ã¾ã›ã‚“ã€‚
ã¾ãŸã€ã‚³ãƒ³ãƒ†ãƒŠã®å®Ÿè¡Œæ¨©é™ã‚’rootä»¥å¤–ã«ã—ã¦ã„ã‚‹(nodeã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãã®ã¾ã¾åˆ©ç”¨ã—ã¦ã„ã‚‹ãªã©)å ´åˆã¯`chown`ãªã©ã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™ã‚’å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

#### Cacheã®å±•é–‹

```yaml
    - name: docker volume create
      run: |
        docker volume create test_node_modules
        sudo cp -r /tmp/node_modules/. /var/lib/docker/volumes/test_node_modules/_data
    - name: run test on docker-compose
      run: |
        docker compose run --rm react yarn install
        sudo cp -rf /var/lib/docker/volumes/test_node_modules/_data/. /tmp/node_modules
      working-directory: ./
```

Dockerã®Volumeã‚’ä½œæˆã—ã€CacheãŒå±•é–‹ã•ã‚ŒãŸ`/tmp/node_modules`ã‚’Dockerã®Volumeã¸ã‚³ãƒ”ãƒ¼ã—ã¦ã„ã¾ã™ã€‚
ãªãœãã‚“ãªã“ã¨ã‚’ã—ã¦ã„ã‚‹ã‹ã¨ã„ã†ã¨ã€`docker-compose.yml`ã§åå‰ä»˜ããƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦ãŠã‚Šã€é–‹ç™ºç’°å¢ƒã§åˆ©ç”¨ã™ã‚‹YAMLã‚’ãã®ã¾ã¾åˆ©ç”¨ã—ãŸã‹ã£ãŸãŸã‚ã€å‰²ã¨åŠ›æŠ€ã§åå‰ä»˜ããƒœãƒªãƒ¥ãƒ¼ãƒ å†…ã¸ã‚³ãƒ”ãƒ¼ã—ã¦ã„ã¾ã™ã€‚
ãªãŠã€å¤–éƒ¨ã§ä½œæˆã•ã‚ŒãŸVolumeã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã¯`external`ã‚’æŒ‡å®šã—ãªã„ã¨ã„ã‘ãªã„ã®ã§ã™ãŒã€é–‹ç™ºç’°å¢ƒã§ã¯`docker-compose.yml`å†…ã«é–‰ã˜ã¦ãŠã„ã¦ã»ã—ã‹ã£ãŸãŸã‚ã€ç’°å¢ƒå¤‰æ•°ã§åˆ¶å¾¡ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã—ãŸã€‚

```yaml
volumes:
  node_modules:
    name: test_node_modules
    external: ${VOLUME_EXTERNAL:-false}
```

`yarn install`å®Œäº†å¾Œã€Volumeå†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’`/tmp/node_modules`ã¸ã‚³ãƒ”ãƒ¼ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€CacheãŒHitã—ãªã‹ã£ãŸã¨ãã®å¯¾å¿œã¨ãªã‚Šã¾ã™ã€‚
ã‚³ãƒ”ãƒ¼éƒ¨åˆ†ã¯åˆ¥ã®Stepã«åˆ†ã‘ã¦ã€CacheãŒHitã—ãªã‹ã£ãŸã¨ãã ã‘å‹•ä½œã™ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã»ã†ãŒå¾Œã€…installã™ã‚‹packageã®æ•°ãŒå¢—ãˆãŸã¨ãã«å½±éŸ¿ã‚’å—ã‘ãªãã¦ã™ã‚€ã¨æ€ã„ã¾ã™ã€‚

### Dockerã®Cache

#### BuildKitã®æœ‰åŠ¹åŒ–

```yaml
    - uses: docker/setup-buildx-action@v2
```

[docker/setup-buildx-action](https://github.com/docker/setup-buildx-action)ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€Buildkitã‚’æœ‰åŠ¹åŒ–ã§ãã¾ã™ã€‚
ãã®çµæžœã€Docker Buildã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

#### Dockerã®Cacheã®èª­ã¿è¾¼ã¿ãŠã‚ˆã³Imageã®Load

```yaml
    - uses: docker/build-push-action@v4
      with:
        context: ./frontend
        build-args: |
          NODE_VER=${{ env.NODE_VER }}
          FIREBASE_VER=${{ env.FIREBASE_VER }}
        tags: test-react:latest
        load: true
        cache-from: type=gha,scope=react
        cache-to: type=gha,mode=max,scope=react
    - uses: docker/build-push-action@v4
      with:
        context: ./firebase_emulator
        build-args: |
          NODE_VER=${{ env.NODE_VER }}
          OPEN_JDK_VER=${{ env.OPEN_JDK_VER }}
          FIREBASE_VER=${{ env.FIREBASE_VER }}
        tags: test-emulator:latest
        load: true
        cache-from: type=gha,scope=emulator
        cache-to: type=gha,mode=max,scope=emulator
```

[docker/build-push-action](https://github.com/docker/build-push-action)ã¯Docker Imageã‚’BuildãŠã‚ˆã³Pushã™ã‚‹ãŸã‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ãªã‚Šã¾ã™ã€‚
ã“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã‚‚ã¤ã„ã¦ãŠã‚Šã€`cache-from`ã¨`cache-to`ã§æŒ‡å®šã§ãã¾ã™ã€‚ãã‚Œãžã‚Œã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦ã¯GitHubã®å…¬å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
ä»Šå›žã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®Dockerã¨Firebaseã®ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã®Dockerã‚’Buildã—ã¦ãŠã‚Šã€1ã¤æ³¨æ„ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚
ãã‚Œã¯`scope`ã®æŒ‡å®šã§ã™ã€‚`scope`ã‚’æŒ‡å®šã—ãªã„ã¨ã€åŒã˜å ´æ‰€ã¸Cacheã—ã¦ã—ã¾ã„ä¸Šæ›¸ãã—ã¦ã—ã¾ã„ã¾ã™ã€‚
è¤‡æ•°ã®Dockerã‚’Buildã™ã‚‹éš›ã¯æŒ‡å®šãŒå¿…è¦ã«ã‚ã‚Šã¾ã™ã®ã§ã”æ³¨æ„ãã ã•ã„ã€‚
ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
https://pc.atsuhiro-me.net/entry/2023/02/05/111750

ã¾ãŸã€`load`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€Cacheã‹ã‚‰Docker Imageã‚’Loadã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
Loadã™ã‚‹éš›ã®æ³¨æ„ç‚¹ã¨ã—ã¦ã€`docker-compose.yml`ã«æŒ‡å®šã—ã¦ã„ã‚‹Imageåã¨æŒ‡å®šã—ã¦ã„ã‚‹Imageåã‚’ã‚ã‚ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
åˆã‚ã›ã‚‹ã“ã¨ã§äº‹å‰ã«Loadã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ãŒåˆ©ç”¨ã•ã‚Œã¦ã€`docker compose run`ã‚’è¡Œã†éš›ã«Buildã•ã‚Œãªããªã‚Šã¾ã™ã€‚

```yaml
  react:
    image: test-react:latest
    build:
      args:
        - NODE_VER=18.16.0-slim
        - FIREBASE_VER=12.3.0
      context: ./frontend
```

## 2. ESLintã€Vitestã®Job

`ESLint`ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®JobãŒä»¥ä¸‹ã¨ãªã‚Šã¾ã™ã€‚

```yaml
  lint:
    name: Lint
    needs:
      - setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      COMMIT_HASH: ${{ needs.setup.outputs.commit-hash }}
    steps:
      - name: checkout pushed commit
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - uses: docker/setup-buildx-action@v2
      - uses: docker/build-push-action@v4
        with:
          context: ./frontend
          build-args: |
            NODE_VER=${{ env.NODE_VER }}
            FIREBASE_VER=${{ env.FIREBASE_VER }}
          tags: test-react:latest
          load: true
          cache-from: type=gha,scope=react
          cache-to: type=gha,mode=max,scope=react
      - name: Cache node_modules
        uses: actions/cache@v3
        id: test_node_modules
        with:
          path: /tmp/node_modules/
          key: test_node_modules-${{env.COMMIT_HASH}}
      - name: docker volume create
        run: |
          docker volume create test_node_modules
          sudo cp -r /tmp/node_modules/. /var/lib/docker/volumes/test_node_modules/_data
      - name: run lint
        run: docker compose run --rm react yarn lint
        working-directory: ./
```

Cacheå‘¨ã‚Šã®Actionã¯ç’°å¢ƒæº–å‚™ç”¨ã®Jobã¨å¤‰ã‚ã‚Šã¾ã›ã‚“ã€‚
é•ã„ã¯`needs`ã®æŒ‡å®šã¨ã€yarn.lockã®Commitã®Hashã‚’å–å¾—ã™ã‚‹ã¨ã“ã‚ã®ã¿ã¨ãªã‚Šã¾ã™ã€‚

```yaml
[çœç•¥]
    needs:
      - setup
[çœç•¥]
    env:
      COMMIT_HASH: ${{ needs.setup.outputs.commit-hash }}
```

`needs`ã¯äº‹å‰ã«å‹•ã„ã¦ãŠãå¿…è¦ãŒã‚ã‚‹Jobã‚’æŒ‡å®šã—ã¾ã™ã€‚ä»Šå›žã¯ç’°å¢ƒæº–å‚™ç”¨ã®JobãŒäº‹å‰ã«å‹•ã„ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ãŸã‚æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚
ã¾ãŸã€yarn.lockã®Commitã®Hashã¯ç’°å¢ƒæº–å‚™ç”¨ã®Jobã§Outputsã«æŒ‡å®šã—ãŸå€¤ã‚’ç’°å¢ƒå¤‰æ•°`COMMIT_HASH`ã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚
`needs.[Jobå].outputs.[key]`ã§å‚ç…§å¯èƒ½ã§ã™ã€‚

Vitestã«ã¤ã„ã¦ã‚‚ã€æœ€å¾Œã«å®Ÿæ–½ã™ã‚‹Stepã®å†…å®¹ãŒç•°ãªã‚‹ã ã‘ã§ã™ã€‚

## æœ€å¾Œã«

ä¸¦åˆ—ã§å®Ÿè¡Œã—ã¦ã¿ã¦ã€CacheãŒãã„ãŸãŠã‹ã’ã§CIã®å®Ÿè¡Œæ™‚é–“ã‚’1åˆ†ã»ã©çŸ­ç¸®ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚
å€‹äººé–‹ç™ºãªã®ã§ãã“ã¾ã§æ©æµã¯ãªã„ã®ã§ã™ãŒã€ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã§GitHubActionsã‚’åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹æ–¹ãªã©ã¯ä¸¦åˆ—åŒ–ã¯ãƒ‡ãƒªãƒãƒªãƒ¼é€Ÿåº¦ã«ã‚‚å¤§ããå½±éŸ¿ã—ã¦ãã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚
Docker Volumeã®ã‚³ãƒ”ãƒ¼ã®ã¨ã“ã‚ãªã©ã¯åŠ›æŠ€æ„ŸãŒã‚ã‚Šã€ã‚‚ã£ã¨ã†ã¾ãã§ããªã„ã‚‚ã®ã‹æ‚©ã¿ã¾ã™ãŒã€ä»Šã®æ§‹æˆã§ã¯ã“ã†ãªã‚‰ã–ã‚‹ã‚’å¾—ãªã„æ°—ã‚‚ã—ã¾ã™ã€‚
Buildç”¨ã®Docker Imageã‚’ä½œæˆã™ã‚‹ã¨ã„ã†ã®ã‚‚æ‰‹ã ã¨ã¯æ€ã£ã¦ã„ã‚‹ã®ã§ã™ãŒã€ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚ã–ã‚ã–ä½¿ã†ã®ã‚‚ãªâ€¦ã¨æ€ã„ã“ã®æ‰‹æ®µã§å®Ÿæ–½ã—ã¦ã¿ã¾ã—ãŸã€‚

ã©ãªãŸã‹ã®ãŠå½¹ã«ç«‹ã¦ã°å¹¸ã„ã§ã™ã€‚

â€»æœ€çµ‚çš„ã«ä»¥ä¸‹ã®Workflowã«ãªã‚Šã¾ã—ãŸã€‚

```yaml
name: FrontEnd Testing
on:
  pull_request:
env:
  NODE_VER: 18.16.0-slim
  OPEN_JDK_VER: 20-slim
  FIREBASE_VER: 12.3.0
  VOLUME_EXTERNAL: true
jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      commit-hash: ${{ steps.yarn-lock-file-commit-hash.outputs.commit-hash }}
    timeout-minutes: 10
    steps:
      - name: checkout pushed commit
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Yarn Lock File Commit Hash
        id: yarn-lock-file-commit-hash
        run: |
          COMMIT_HASH="$(git log -n 1 --pretty=%H --date-order -- frontend/yarn.lock)"
          echo "COMMIT_HASH=${COMMIT_HASH}" >> $GITHUB_ENV
          echo "commit-hash=$COMMIT_HASH" >> GITHUB_OUTPUT
      - uses: docker/setup-buildx-action@v2
      - uses: docker/build-push-action@v4
        with:
          context: ./frontend
          build-args: |
            NODE_VER=${{ env.NODE_VER }}
            FIREBASE_VER=${{ env.FIREBASE_VER }}
          tags: test-react:latest
          load: true
          cache-from: type=gha,scope=react
          cache-to: type=gha,mode=max,scope=react
      - uses: docker/build-push-action@v4
        with:
          context: ./firebase_emulator
          build-args: |
            NODE_VER=${{ env.NODE_VER }}
            OPEN_JDK_VER=${{ env.OPEN_JDK_VER }}
            FIREBASE_VER=${{ env.FIREBASE_VER }}
          tags: test-emulator:latest
          load: true
          cache-from: type=gha,scope=emulator
          cache-to: type=gha,mode=max,scope=emulator
      - name: Cache node_modules
        uses: actions/cache@v3
        id: test_node_modules
        with:
          path: /tmp/node_modules/
          key: test_node_modules-${{env.COMMIT_HASH}}
      - name: Cache Directory
        if: steps.test_node_modules.outputs.cache-hit != 'true'
        run: |
          sudo mkdir -p /tmp/node_modules
      - name: docker volume create
        run: |
          docker volume create test_node_modules
          sudo cp -r /tmp/node_modules/. /var/lib/docker/volumes/test_node_modules/_data
      - name: run test on docker-compose
        run: |
          docker compose run --rm react yarn install
          sudo cp -rf /var/lib/docker/volumes/test_node_modules/_data/. /tmp/node_modules
        working-directory: ./
  lint:
    name: Lint
    needs:
      - setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      COMMIT_HASH: ${{ needs.setup.outputs.commit-hash }}
    steps:
      - name: checkout pushed commit
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - uses: docker/setup-buildx-action@v2
      - uses: docker/build-push-action@v4
        with:
          context: ./frontend
          build-args: |
            NODE_VER=${{ env.NODE_VER }}
            FIREBASE_VER=${{ env.FIREBASE_VER }}
          tags: test-react:latest
          load: true
          cache-from: type=gha,scope=react
          cache-to: type=gha,mode=max,scope=react
      - name: Cache node_modules
        uses: actions/cache@v3
        id: test_node_modules
        with:
          path: /tmp/node_modules/
          key: test_node_modules-${{env.COMMIT_HASH}}
      - name: docker volume create
        run: |
          docker volume create test_node_modules
          sudo cp -r /tmp/node_modules/. /var/lib/docker/volumes/test_node_modules/_data
      - name: run lint
        run: docker compose run --rm react yarn lint
        working-directory: ./
  test:
    name: Test
    needs:
      - setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      COMMIT_HASH: ${{ needs.setup.outputs.commit-hash }}
    steps:
      - name: checkout pushed commit
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - uses: docker/setup-buildx-action@v2
      - uses: docker/build-push-action@v4
        with:
          context: ./frontend
          build-args: |
            NODE_VER=${{ env.NODE_VER }}
            FIREBASE_VER=${{ env.FIREBASE_VER }}
          tags: test-react:latest
          load: true
          cache-from: type=gha,scope=react
          cache-to: type=gha,mode=max,scope=react
      - uses: docker/build-push-action@v4
        with:
          context: ./firebase_emulator
          build-args: |
            NODE_VER=${{ env.NODE_VER }}
            OPEN_JDK_VER=${{ env.OPEN_JDK_VER }}
            FIREBASE_VER=${{ env.FIREBASE_VER }}
          tags: test-emulator:latest
          load: true
          cache-from: type=gha,scope=emulator
          cache-to: type=gha,mode=max,scope=emulator
      - name: Cache node_modules
        uses: actions/cache@v3
        id: test_node_modules
        with:
          path: /tmp/node_modules/
          key: test_node_modules-${{env.COMMIT_HASH}}
      - name: docker volume create
        run: |
          docker volume create test_node_modules
          sudo cp -r /tmp/node_modules/. /var/lib/docker/volumes/test_node_modules/_data
      - name: run test
        run: |
          docker compose up -d emulator
          sleep 10
          docker compose run --rm react yarn test
        working-directory: ./
```
